From 9a34c7e2334b432c304f5c4ee856cd8bfa7f9c14 Mon Sep 17 00:00:00 2001
From: chatgpt <chatgpt@openai.com>
Date: Fri, 21 Jun 2025 22:35:00 +0000
Subject: [PATCH] fix: ajuste de fechamento de posicao com stepSize correto

---
 src/services/orderService.ts | 12 ++++++++++++
 1 file changed, 12 insertions(+)

--- a/src/services/orderService.ts
+++ b/src/services/orderService.ts
@@ -1234,6 +1234,18 @@
     for (const pos of positions) {
       const side = pos.side === "BUY" ? "SELL" : "BUY";
       const qty = Math.abs(pos.positionAmt).toString();
+      const filters = (await fetchExchangeFilters())[pos.symbol] as FullSymbolFilters;
+      if (!filters) {
+        console.warn(`⚠️ Não foi possível obter filtros para ${pos.symbol}. Pulando.`);
+        continue;
+      }
+
+      const prec = Math.round(-Math.log10(filters.stepSize));
+      const safeQty = Math.max(
+        parseFloat(qty),
+        parseFloat(filters.minQty || "0.001")
+      ).toFixed(prec);
+
       const timestamp = Date.now() + getTimeOffset();
       const recvWindow = 60_000;
 
       // Cancelar todas as ordens abertas
@@ -1245,7 +1257,7 @@
         await axios.delete(`${baseUrl}/fapi/v1/allOpenOrders?${query}&signature=${signature}`, {
           headers: { 'X-MBX-APIKEY': apiKey }
         });
       } catch (e: any) {
         console.warn(`⚠️ Falha ao cancelar ordens de ${pos.symbol}: ${e.response?.data?.msg || e.message}`);
       }
 
       // Fechar posição com ordem MARKET reduceOnly
       try {
         const queryParams = new URLSearchParams({
           symbol: pos.symbol,
           side,
           type: 'MARKET',
-          quantity: qty,
+          quantity: safeQty,
           reduceOnly: 'true',
           timestamp: timestamp.toString(),
           recvWindow: recvWindow.toString()
